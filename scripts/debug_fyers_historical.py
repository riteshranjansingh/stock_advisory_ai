#!/usr/bin/env python3
"""
Fyers Historical Data Diagnostic Script
Debug why historical data is failing while stock info works
"""
import sys
import os
from pathlib import Path
from datetime import date, timedelta

# Add project root to path
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.append(str(PROJECT_ROOT))

def test_fyers_authentication():
    """Test if Fyers authentication is working"""
    print("üîê Testing Fyers Authentication")
    print("=" * 35)
    
    try:
        from src.auth.fyers_auth import FyersAuthenticator
        
        # Create authenticator
        auth = FyersAuthenticator()
        
        # Check if token exists and is valid
        print("1. Checking stored token...")
        if auth.load_existing_token():
            print("   ‚úÖ Found stored token")
            
            if auth.is_token_valid():
                print("   ‚úÖ Token is valid (not expired)")
            else:
                print("   ‚ö†Ô∏è  Token appears expired")
                
            # Test token with API call
            print("   üß™ Testing token with API call...")
            if auth.test_token():
                print("   ‚úÖ Token works with API")
                return True
            else:
                print("   ‚ùå Token fails API test")
                return False
        else:
            print("   ‚ùå No stored token found")
            return False
            
    except Exception as e:
        print(f"   ‚ùå Authentication test failed: {e}")
        return False

def test_fyers_symbol_formats():
    """Test different symbol formats with Fyers"""
    print("\nüî§ Testing Fyers Symbol Formats")
    print("=" * 35)
    
    try:
        from src.data.providers.fyers_provider import FyersProvider
        
        # Create provider
        provider = FyersProvider()
        
        # Test if provider is authenticated
        if not provider.authenticate():
            print("‚ùå Provider authentication failed")
            return False
        
        test_symbols = [
            "RELIANCE",
            "NSE:RELIANCE-EQ",
            "NSE:RELIANCE",
            "RELIANCE-EQ"
        ]
        
        print("üìä Testing stock info with different formats:")
        for symbol in test_symbols:
            try:
                result = provider.get_stock_info(symbol)
                if result:
                    print(f"   ‚úÖ {symbol}: Success")
                else:
                    print(f"   ‚ùå {symbol}: No data")
            except Exception as e:
                print(f"   ‚ùå {symbol}: Error - {e}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Symbol format test failed: {e}")
        return False

def test_fyers_historical_formats():
    """Test historical data with different symbol formats"""
    print("\nüìÖ Testing Fyers Historical Data Formats")
    print("=" * 40)
    
    try:
        from src.data.providers.fyers_provider import FyersProvider
        
        # Create provider
        provider = FyersProvider()
        
        # Test if provider is authenticated
        if not provider.authenticate():
            print("‚ùå Provider authentication failed")
            return False
        
        # Get authenticated client directly
        fyers_client = provider.get_authenticated_client()
        if not fyers_client:
            print("‚ùå Could not get Fyers client")
            return False
        
        # Test different symbol formats
        test_symbols = [
            "RELIANCE",
            "NSE:RELIANCE-EQ", 
            "NSE:RELIANCE",
            "RELIANCE-EQ"
        ]
        
        end_date = date.today()
        start_date = end_date - timedelta(days=7)
        
        # Convert to timestamps for Fyers
        import time
        start_timestamp = str(int(time.mktime(start_date.timetuple())))
        end_timestamp = str(int(time.mktime(end_date.timetuple())))
        
        print(f"üìä Testing historical data ({start_date} to {end_date}):")
        
        for symbol in test_symbols:
            try:
                print(f"\n   üîç Testing: {symbol}")
                
                # Test with Fyers history API directly
                data_params = {
                    'symbol': symbol,
                    'resolution': 'D',
                    'date_format': '0',
                    'range_from': start_timestamp,
                    'range_to': end_timestamp,
                    'cont_flag': '1'
                }
                
                print(f"      API params: {data_params}")
                
                response = fyers_client.history(data=data_params)
                print(f"      Response status: {response.get('s', 'unknown')}")
                
                if response.get('s') == 'ok':
                    candles = response.get('candles', [])
                    print(f"      ‚úÖ Success: {len(candles)} candles")
                    if candles:
                        print(f"      üìä Sample data: {candles[0]}")
                else:
                    print(f"      ‚ùå Failed: {response.get('message', 'Unknown error')}")
                    print(f"      Full response: {response}")
                    
            except Exception as e:
                print(f"      ‚ùå Exception: {e}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Historical data test failed: {e}")
        return False

def test_fyers_provider_methods():
    """Test the provider's historical data method specifically"""
    print("\nüîß Testing Fyers Provider Historical Method")
    print("=" * 42)
    
    try:
        from src.data.providers.fyers_provider import FyersProvider
        
        # Create provider
        provider = FyersProvider()
        
        # Test historical data method
        end_date = date.today()
        start_date = end_date - timedelta(days=7)
        
        test_symbols = ["RELIANCE", "TCS"]
        
        for symbol in test_symbols:
            print(f"\nüìä Testing provider.get_historical_data('{symbol}'):")
            
            try:
                # Test the provider method directly
                data = provider.get_historical_data(symbol, start_date, end_date)
                
                if data is not None and len(data) > 0:
                    print(f"   ‚úÖ Success: {len(data)} records")
                    print(f"   üìà Columns: {list(data.columns)}")
                    print(f"   üìä Sample: {data.iloc[0].to_dict()}")
                else:
                    print(f"   ‚ùå No data returned")
                    
            except Exception as e:
                print(f"   ‚ùå Error: {e}")
                import traceback
                traceback.print_exc()
        
        return True
        
    except Exception as e:
        print(f"‚ùå Provider method test failed: {e}")
        return False

def test_fyers_normalization():
    """Test symbol normalization specifically"""
    print("\nüîÑ Testing Fyers Symbol Normalization")
    print("=" * 38)
    
    try:
        from src.data.providers.fyers_provider import FyersProvider
        
        # Create provider
        provider = FyersProvider()
        
        test_symbols = ["RELIANCE", "TCS", "INFY"]
        
        for symbol in test_symbols:
            try:
                print(f"\nüìä Testing normalization for: {symbol}")
                
                # Test normalize_symbol method
                if hasattr(provider, 'normalize_symbol'):
                    normalized = provider.normalize_symbol(symbol)
                    print(f"   üîÑ Normalized: {symbol} ‚Üí {normalized}")
                    
                    # Test denormalize
                    if hasattr(provider, 'denormalize_symbol'):
                        denormalized = provider.denormalize_symbol(normalized)
                        print(f"   üîô Denormalized: {normalized} ‚Üí {denormalized}")
                        
                        if denormalized.upper() == symbol.upper():
                            print(f"   ‚úÖ Round-trip successful")
                        else:
                            print(f"   ‚ùå Round-trip failed")
                    else:
                        print(f"   ‚ö†Ô∏è  No denormalize_symbol method")
                        
                    # Test with stock info
                    print(f"   üß™ Testing stock info with normalized symbol...")
                    stock_info = provider.get_stock_info(normalized)
                    if stock_info:
                        print(f"   ‚úÖ Stock info works with normalized symbol")
                    else:
                        print(f"   ‚ùå Stock info fails with normalized symbol")
                        
                else:
                    print(f"   ‚ö†Ô∏è  No normalize_symbol method found")
                    
            except Exception as e:
                print(f"   ‚ùå Error testing {symbol}: {e}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Normalization test failed: {e}")
        return False

def main():
    """Run comprehensive Fyers diagnostic"""
    print("üîç FYERS HISTORICAL DATA DIAGNOSTIC")
    print("=" * 50)
    print("This will help identify why historical data is failing")
    print("=" * 50)
    
    # Run all diagnostic tests
    tests = [
        ("Authentication", test_fyers_authentication),
        ("Symbol Formats", test_fyers_symbol_formats), 
        ("Historical Formats", test_fyers_historical_formats),
        ("Provider Methods", test_fyers_provider_methods),
        ("Symbol Normalization", test_fyers_normalization)
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        print(f"\n{'='*60}")
        try:
            result = test_func()
            # Ensure result is boolean
            if isinstance(result, tuple):
                result = result[0]
            results[test_name] = bool(result)
            print(f"üìä {test_name}: {'‚úÖ PASSED' if result else '‚ùå FAILED'}")
        except Exception as e:
            print(f"üìä {test_name}: ‚ùå ERROR - {e}")
            results[test_name] = False
    
    # Summary
    print(f"\nüèÜ DIAGNOSTIC SUMMARY")
    print("=" * 25)
    
    passed = sum(results.values())
    total = len(results)
    
    for test_name, result in results.items():
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"   {test_name}: {status}")
    
    print(f"\nOverall: {passed}/{total} tests passed")
    
    # Recommendations
    print(f"\nüí° RECOMMENDATIONS:")
    print("-" * 20)
    
    if not results.get("Authentication", False):
        print("üîê Fix Fyers authentication first")
        print("   ‚Ä¢ Check credentials in .env file")
        print("   ‚Ä¢ Re-run authentication script")
        
    if results.get("Authentication", False) and not results.get("Historical Formats", False):
        print("üìÖ Historical data API issue detected")
        print("   ‚Ä¢ Symbol format might be different for historical API")
        print("   ‚Ä¢ Try different date ranges")
        print("   ‚Ä¢ Check Fyers API documentation")
        
    if results.get("Authentication", False) and results.get("Symbol Formats", False):
        print("üîÑ Provider method issue")
        print("   ‚Ä¢ Check symbol normalization implementation")
        print("   ‚Ä¢ Verify API parameter format")
    
    return passed == total

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)